name: Monthly Intelligence Agent (SMTP 465)

on:
  schedule:
    - cron: '0 10 14 * *'  # Runs at 10:00 UTC on the 14th of every month
  workflow_dispatch:       # Enables manual run

jobs:
  run-monthly-agent:
    runs-on: ubuntu-latest
    
    # REQUIRED: Grant permission to push changes back to the repo
    permissions:
      contents: write
      
    env:
      # HuggingFace Token (prevents rate limiting on model downloads)
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      
      # SMTP 465 credentials for email
      SMTP_HOST_465: ${{ secrets.SMTP_HOST_465 }}
      SMTP_PORT: 465
      SMTP_USER_465: ${{ secrets.SMTP_USER_465 }}
      SMTP_PASS_465: ${{ secrets.SMTP_PASS_465 }}
      EMAIL_TO_465: ${{ secrets.EMAIL_TO_465 }}
      
      # Optional: Other secrets for the agent
      PUBMED_TERM: ${{ secrets.PUBMED_TERM }}
      CLINICALTRIALS_CONDITION: ${{ secrets.CLINICALTRIALS_CONDITION }}
      SEMANTIC_SEARCH_TERMS: ${{ secrets.SEMANTIC_SEARCH_TERMS }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetches full history
          lfs: true       # Enable Git LFS
          ref: main
          
      - name: Setup Git LFS
        run: |
          git lfs install
          # Track Excel files if not already tracked
          if ! grep -q "*.xlsx" .gitattributes 2>/dev/null; then
            echo "*.xlsx filter=lfs diff=lfs merge=lfs -text" >> .gitattributes
            echo "Added .xlsx to Git LFS tracking"
          else
            echo "Excel files already tracked by Git LFS"
          fi
          
      - name: Check for existing database
        run: |
          echo "Checking for existing database file..."
          if [ -f "industry_deals/exosome_deals_DATABASE.xlsx" ]; then
            echo "Found existing database:"
            ls -lh industry_deals/exosome_deals_DATABASE.xlsx
          else
            echo "No existing database found - will create new one"
          fi
          
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install lxml[html_clean] newspaper3k trafilatura openpyxl python-dotenv
          python -m spacy download en_core_web_sm
          
      - name: Verify All Required Secrets
        run: |
          echo "----------------------------------------"
          echo "Checking environment variables..."
          echo "----------------------------------------"
          
          # Check SMTP credentials
          if [ -z "$SMTP_HOST_465" ]; then
            echo "FAIL: SMTP_HOST_465 is MISSING"
          else
            echo "PASS: SMTP_HOST_465 is set"
          fi
          
          if [ -z "$SMTP_USER_465" ]; then
            echo "FAIL: SMTP_USER_465 is MISSING"
          else
            echo "PASS: SMTP_USER_465 is set"
          fi
          
          if [ -z "$SMTP_PASS_465" ]; then
            echo "FAIL: SMTP_PASS_465 is MISSING"
          else
            echo "PASS: SMTP_PASS_465 is set"
          fi
          
          if [ -z "$EMAIL_TO_465" ]; then
            echo "FAIL: EMAIL_TO_465 is MISSING"
          else
            echo "PASS: EMAIL_TO_465 is set"
          fi
          
          # Check HuggingFace token
          if [ -z "$HF_TOKEN" ]; then
            echo "WARNING: HF_TOKEN is NOT SET (optional but recommended for faster downloads)"
          else
            echo "PASS: HF_TOKEN is set"
          fi
          
          echo "----------------------------------------"
          echo ""
          
          # Fail if critical secrets are missing
          if [ -z "$SMTP_HOST_465" ] || [ -z "$SMTP_USER_465" ] || [ -z "$SMTP_PASS_465" ] || [ -z "$EMAIL_TO_465" ]; then
            echo "ERROR: Missing critical SMTP secrets"
            echo ""
            echo "Required secrets in GitHub:"
            echo "   - SMTP_HOST_465 (e.g., smtp.gmail.com)"
            echo "   - SMTP_USER_465 (your email)"
            echo "   - SMTP_PASS_465 (app password, not regular password)"
            echo "   - EMAIL_TO_465 (recipient email)"
            echo "   - HF_TOKEN (from huggingface.co/settings/tokens, optional)"
            exit 1
          fi
          
      - name: Run Monthly Intelligence Agent
        run: |
          echo "Starting monthly run for NeuroCell Intelligence"
          python industry_deals_agent.py
          echo "Run completed"
          
      - name: Configure Git Identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
      - name: Git Pull with Rebase - Handle Concurrent Pushes
        run: |
          echo "Handling uncommitted changes..."
          echo "Stashing uncommitted changes (if any)..."
          git stash || true
          
          echo "Pulling latest changes from remote..."
          git pull --rebase origin main || echo "Nothing to pull from remote"
          
          echo "Restoring stashed changes..."
          git stash pop || echo "No stashed changes to restore"
          
          echo "Git pull complete"
          
      - name: Commit and Push Updated Database
        if: always()
        run: |
          FILE_PATH="industry_deals/exosome_deals_DATABASE.xlsx"
          
          if [ -f "$FILE_PATH" ]; then
            echo "Database file found at: $FILE_PATH"
            ls -lh "$FILE_PATH"
            
            # Stage files
            git add .gitattributes 2>/dev/null || echo "No .gitattributes changes"
            git add "$FILE_PATH"
            
            # Check if there are changes to commit
            if git diff --cached --quiet; then
              echo "No new changes to commit"
            else
              echo "Committing changes..."
              git commit -m "Auto-update: Exosome Deals Database [$(date +'%Y-%m-%d %H:%M UTC')]"
              
              # Push to main
              echo "Pushing to remote..."
              git push origin main
              
              echo "Database successfully committed and pushed via Git LFS"
            fi
          else
            echo "No database file generated in this run"
          fi
          
      - name: Upload Log Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monthly-run-logs
          path: neurocell_agent.log
          retention-days: 30
          
      - name: Upload Excel Output Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monthly-excel-output
          path: industry_deals/exosome_deals_*.xlsx
          retention-days: 90
